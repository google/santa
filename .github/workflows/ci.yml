name: CI

on:
  push:
    branches:
      - '*'
    paths:
      - 'Source/**'
  pull_request:
    branches:
      - main
    paths:
      - 'Source/**'

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run linters
        run: ./Testing/lint.sh

  build_userspace:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-11, macos-12]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v2
      - name: Build Userspace
        run: bazel build --apple_generate_dsym -c opt :release --define=SANTA_BUILD_TYPE=adhoc

  start_vm:
    runs-on: e2e-host
    steps:
      - uses: actions/checkout@v2
      - name: Start VM
        run: |
          pip3 install --user google-cloud-storage==2.5.0
          python3 Testing/integration/actions/start-vm.py macOS_12.bundle.tar.gz

  integration:
    runs-on: e2e-vm
    env:
      VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
    steps:
      - uses: actions/checkout@v2
      - name: Install configuration profile
        run: bazel run //Testing/integration:install_profile -- Testing/integration/configs/default.mobileconfig
      - name: Add homebrew to PATH
        run: echo "/opt/homebrew/bin/" >> $GITHUB_PATH
      - name: Install and start moroz
        run: |
          go install github.com/kallsyms/moroz/cmd/moroz@d0bba3f4
          ~/go/bin/moroz -configs="$GITHUB_WORKSPACE/Testing/integration/configs/moroz_default/global.toml" -use-tls=false &
      - name: Build, install, and sync santa
        run: |
          bazel run :reload --define=SANTA_BUILD_TYPE=adhoc
          bazel run //Testing/integration:allow_sysex
          sudo santactl sync --debug
      - name: Run integration test binaries
        run: bazel test //Testing/integration:integration_tests
      - name: Test config changes
        run: ./Testing/integration/test_config_changes.sh
      - name: Test sync server changes
        run: ./Testing/integration/test_sync_changes.sh
      - name: Poweroff
        if: ${{ always() }}
        run: sudo shutdown -h +1

  unit_tests:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-11, macos-12]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v2
      - name: Run All Tests
        run: bazel test :unit_tests --define=SANTA_BUILD_TYPE=adhoc --test_output=errors

  test_coverage:
    runs-on: macos-11
    steps:
      - uses: actions/checkout@v2
      - name: Generate test coverage
        run: sh ./generate_cov.sh
      - name: Coveralls
        uses: coverallsapp/github-action@master
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: ./bazel-out/_coverage/_coverage_report.dat
          flag-name: Unit
