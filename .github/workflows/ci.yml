name: CI

on:
  push:
    branches:
      - '*'
  pull_request:
    branches:
      - main
    paths:
      - 'Source/**'

jobs:
  # build_userspace:
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       os: [self-hosted]
  #   runs-on: ${{ matrix.os }}
  #   steps:
  #     - uses: actions/checkout@v2
  #     - name: set path
  #       run: echo "/opt/homebrew/bin/" >> $GITHUB_PATH
  #     - name: Build Userspace
  #       run: bazel build --apple_generate_dsym -c opt :release --define=SANTA_BUILD_TYPE=adhoc

  start_vm:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v2
      # - name: setup
      #   run: pip3 install google-cloud-storage==2.5.0
      - name: run VM
        run: |
          ls -al /opt/VMs
          ls -al /opt/VMs/VM.bundle
          python3 Testing/integration/actions/start-vm.py VM.bundle.tar.gz.enc

  integration:
    runs-on: inner
    steps:
      - uses: actions/checkout@v2
      - name: set path
        run: echo "/opt/homebrew/bin/" >> $GITHUB_PATH
      - name: run moroz
        run: ~/go/bin/moroz -configs="$GITHUB_WORKSPACE/Testing/global.toml" -use-tls=false &
      - name: start santa and sync
        run: |
          bazel run :reload --define=SANTA_BUILD_TYPE=adhoc
          sudo santactl sync --debug
      - name: run integration test binaries
        run: bazel test //Testing/integration:integration_tests
      # - name: poweroff
      #   run: sudo shutdown -h now

  # unit_tests:
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       os: [self-hosted]
  #   runs-on: ${{ matrix.os }}
  #   steps:
  #     - uses: actions/checkout@v2
  #     - name: set path
  #       run: echo "/opt/homebrew/bin/" >> $GITHUB_PATH
  #     - name: Run All Tests
  #       run: bazel test :unit_tests --define=SANTA_BUILD_TYPE=adhoc --test_output=errors
